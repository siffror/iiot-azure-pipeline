type: Microsoft.App/containerApps
apiVersion: 2023-08-01
name: mosquitto
location: northeurope
properties:
  managedEnvironmentId: /subscriptions/5e58abe7-2302-449a-a7a2-35f2b3c4b886/resourceGroups/iiot-poc-rg/providers/Microsoft.App/managedEnvironments/iiot-env-public
  configuration:
    activeRevisionsMode: Single
    ingress:
      external: false            # s√§tt true om du vill n√•s externt (kr√§ver VNET f√∂r TCP i m√•nga konfigurationer)
      targetPort: 1883
      transport: tcp
      traffic:
        - latestRevision: true
          weight: 100
    # üîê deklarera secret h√§r (v√§rdet s√§tts via CLI/Workflow ‚Äì inte i filen)
    secrets:
      - name: mosqconf
        value: ""                # l√§mna tomt i git; fylls via az containerapp secret set
  template:
    containers:
      - name: mosquitto
        image: __IMAGE__         # placeholder ‚Äî ers√§tt via CI (workflow g√∂r sed/replace)
        env:
          - name: TZ
            value: UTC
        # K√∂r mosquitto med din konfig-fil som mountas som fil i /appconfig
        command:
          - /usr/sbin/mosquitto
        args:
          - -c
          - /appconfig/mosquitto.conf
          - -v
        resources:
          cpu: 0.5
          memory: 1.0Gi
        volumeMounts:
          # ‚úÖ montera ENDAST data-katalogen p√• Azure Files
          - volumeName: mosquitto-data
            mountPath: /mosquitto/data
          # üîê montera secret som FIL-katalog (inneh√•ller mosquitto.conf)
          - volumeName: mosqconfvol
            mountPath: /appconfig
        probes:
          - type: Liveness
            tcpSocket:
              port: 1883
            initialDelaySeconds: 10
            periodSeconds: 10
            failureThreshold: 3
          - type: Readiness
            tcpSocket:
              port: 1883
            initialDelaySeconds: 5
            periodSeconds: 10
    scale:
      minReplicas: 1
      maxReplicas: 1
    volumes:
      # üóÇÔ∏è Azure Files (data) ‚Äî storageName m√•ste existera som en storage binding i Managed Environment
      - name: mosquitto-data
        storageType: AzureFile
        storageName: mosquitto-data-storage
      # üîê Secret-volym f√∂r konfigfilen (refererar till secrets.name ovan)
      - name: mosqconfvol
        secret:
          secretRef: mosqconf
