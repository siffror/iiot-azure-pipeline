###############################################################################
# ðŸ§  Telegraf agent
###############################################################################
[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  logfile = ""                  # stdout (ACA loggar till Log Analytics)
  omit_hostname = false

###############################################################################
# ðŸ“¥ INPUTS
###############################################################################
[[inputs.internal]]             # FÃ¶r hÃ¤lsomÃ¤tning (write_errors m.m.)

# MQTT â†’ JSON (FFT-data frÃ¥n Mosquitto)
[[inputs.mqtt_consumer]]
  servers = ["${MQTT_URL}"]     # tcp://mosquitto.happyisland-fa52694f.northeurope.azurecontainerapps.io:1883
  topics = ["sensors/vibration_fft/#"]
  qos = 0
  connection_timeout = "30s"
  persistent_session = false
  client_id = "telegraf-fft"
  data_format = "json"

###############################################################################
# ðŸ“¤ OUTPUTS
###############################################################################
# InfluxDB v2 (writes)
[[outputs.influxdb_v2]]
  urls          = ["${INFLUX_URL}"]      # https://influxdb.internal.happyisland-fa52694f.northeurope.azurecontainerapps.io
  token         = "${INFLUX_TOKEN}"      # sÃ¤tts som secretRef
  organization  = "${INFLUX_ORG}"
  bucket        = "${INFLUX_BUCKET}"

  ## TLS verifiering (slÃ¥ *pÃ¥* verify)
  insecure_skip_verify = false

###############################################################################
# ðŸ©º Health endpoint (fÃ¶r ACA probes)
###############################################################################
[[outputs.health]]
  # GÃ¶r /health tillgÃ¤nglig pÃ¥ port 8080
  service_address = "http://:8080"

  # FAIL om write_errors >= 1 i Influx-outputen
  [[outputs.health.compares]]
    field = "write_errors"
    lt = 1.0
    namepass = ["internal_write"]
    tagpass = { output = ["influxdb_v2"] }
