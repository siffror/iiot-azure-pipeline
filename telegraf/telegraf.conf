###############################################################################
# Telegraf agent
###############################################################################
[agent]
  interval = "10s"              # how often to gather metrics (tune as needed)
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"        # consider 1s for lower latency
  flush_jitter = "0s"
  logfile = ""                  # stdout

###############################################################################
# INPUTS
###############################################################################
[[inputs.internal]]             # needed for health comparisons

# MQTT FFT stream -> JSON
[[inputs.mqtt_consumer]]
  servers = ["${MQTT_URL}"]     # e.g. tcp://iiot-mosquitto:1883
  topics = ["sensors/vibration_fft/#"]
  qos = 0
  connection_timeout = "30s"
  persistent_session = false
  client_id = "telegraf-fft"
  data_format = "json"          # expects JSON payloads (json_v2 om du har nÃ¤stlade objekt)
  # name_override = "fft"

###############################################################################
# OUTPUTS
###############################################################################
# InfluxDB v2 (writes)
[[outputs.influxdb_v2]]
  urls = ["${INFLUX_URL}"]      # e.g. http://iiot-influxdb:8086
  token = "${INFLUX_TOKEN}"
  organization = "${INFLUX_ORG}"  # must match Influx
  bucket = "${INFLUX_BUCKET}"     # must match Influx
  # timeout = "5s"

# HTTP health endpoint (ACA probes)
[[outputs.health]]
  service_address = "http://:8080/health"

  # FAIL if write_errors >= 1 for the influxdb_v2 output
  [[outputs.health.compares]]
    field = "write_errors"
    lt = 1
    namepass = ["internal_write"]
    tagpass = { output = ["influxdb_v2"] }
